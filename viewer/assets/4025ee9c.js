var N=Object.defineProperty;var F=(i,a,e)=>a in i?N(i,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[a]=e;var m=(i,a,e)=>(F(i,typeof a!="symbol"?a+"":a,e),e);import{b,l as V,s as E,d as O,e as D,p as g,R as l,f as L,h as B,L as T,i as j,j as W,k as z,m as H,w as _,n as q,o as G,P as K,q as M,t as Z}from"./index.dc3130ce.js";import{P as $,i as J}from"./14d330bb.js";import{a as Q}from"./466da4d5.js";var X=()=>{const{href:i}=window.location,a=i.lastIndexOf("/");return i.slice(0,a)};const Y={kioskMode:!0,noNewFiles:!0,showControls:!1,showControlBar:!1,showImageButtons:!1,showOrientation:!0,radiological:!0,fullscreen:!0,padAllImages:!1,orthogonalDynamic:!0};class ee{constructor(a,e,t,o,s){m(this,"convertFromCornerstoneImage",async a=>{if(!Array.isArray(a))return;const e=[];window.testImage=await b.loadImage(a[0]),a.forEach(n=>{const p=b.metaData.get("all",n),w=n.replace("/frames/1","");Q.wadors.metaDataManager.add(w,p),e.push(w)});const{initParams:t,papayaParams:o,papayaViewport:s}=this;let h=[],d=[],S=0;const C=n=>{s.setState({loadPercent:Math.floor(n/a.length*100)})},f=100,u=V.exports.chunk(e,f);window.vDebug.log("batches",u);for(let n=0;n<u.length;n++){for(let p=0;p<u[n].length;p++)h.push(b.loadAndCacheImage(u[n][p],'multipart/related; type="image/x-jls"; transfer-syntax="1.2.840.10008.1.2.4.80"').then(w=>(C(++S),window.vDebug.log("download process",Math.floor(S/a.length*100)),w)));d.push(await Promise.all(h)),h=[]}d=V.exports.flatten(d),window.vDebug.log("cornerstone images",d);const r=[];d.forEach(n=>{r.push(n.getPixelData().buffer)}),window.vDebug.log("image data",r),window.papayaContainers.length===0&&(window.vDebug.log("Starting papaya",window.papayaContainers),window.papaya.Container.startPapaya()),s.setState({progressLabel:s.props.translate("viewer.message.MPRBuild")}),o.binaryImages=[r],window.papaya.Container.addImage(0,r,o),window.papaya.Container.resetViewer(0,o),window.papayaContainers[0].viewer.volume.reactPapayaViewport=s,window.papayaContainers[0].viewer.reactViewerConnector.PapayaViewport=s,E(window.papayaContainers[0],t.activeTool)});m(this,"cancelCurrentPromisePool",()=>{this.abort=!0});m(this,"loadFromCornerstoneImage",async a=>{if(!Array.isArray(a.imageIds))return;window.vDebug.log("loadFromCornerstoneImage");const{imageIds:e}=a,{initParams:t,papayaParams:o,papayaViewport:s}=this,h=r=>{s.setState({loadPercent:Math.floor(r/e.length*100)})};let d=0;const S=()=>{if(d<e.length&&!this.abort){const r=b.loadAndCacheImage(e[d]);return d++,r}return null},C=new $(S,10),f=[];let u=0;if(C.addEventListener("fulfilled",r=>{if(!this.abort){const n=r.data.result,p=e.indexOf(n.imageId);f[p]=n,h(++u)}}),await C.start(),!this.abort){const n=O.publicAPI.findOrCreateCornerstoneImageStack(a,this.displaySet).getVolume();f.forEach(p=>{p.metadata=b.metaData.get("all",p.imageId)}),(!window.papayaContainers||window.papayaContainers.length===0)&&(window.vDebug.log("Starting papaya",window.papayaContainers),window.papaya.Container.startPapaya()),s.setState({progressLabel:s.props.translate("viewer.message.MPRBuild")}),window.papaya.Container.resetViewer(0,o),n._buffer?window.papaya.Container.addCornerstoneStackBuffer(0,o,f,a,n._data.buffer):s.setState({progressLabel:s.props.translate("viewer.message.noMemory")}),window.papayaContainers[0].viewer.volume.reactPapayaViewport=s,window.papayaContainers[0].viewer.reactViewerConnector.PapayaViewport=s,E(window.papayaContainers[0],t.activeTool)}});this.initParams=a,this.papayaParams=e,this.papayaViewport=s,this.stack=t,this.displaySet=o,this.promisePool=null,this.abort=!1}}class A extends D.exports.Component{constructor(e){super(e);m(this,"state",{loadPercent:0,finishedLoading:null,progressLabel:this.props.translate("viewer.message.Downloading")});m(this,"setStateFromProps",()=>{const{showNotification:e,stack:t,displaySet:o}=this.props;this.setState({finishedLoading:t.finishedLoading});const s={activeTool:"StackScroll"};this.loader=new ee(s,Y,t,o,this),J(t.calculatedSpacings)||e("viewer.message.SliceSpacingWarning","info",{}),this.loader.loadFromCornerstoneImage(t)});m(this,"applyIntensity",V.exports.debounce(()=>{const{plugin:e,slabThickness:t,blendMode:o}=this.props.viewportSpecificData;e==="papaya"&&t>0&&B(t,o,window.papayaContainers[0].viewer.reactViewerConnector.purgeIPCache,window.papayaContainers[0].viewer.reactViewerConnector.purgeFinishedIPCache),window.papayaContainers[0].viewer.reactViewerConnector.purgeIPCache=!1,window.papayaContainers[0].viewer.reactViewerConnector.purgeFinishedIPCache=!1},50));m(this,"onWindowResize",()=>{if(window.vDebug.log("React resize",this.wrapperRef.current.clientWidth,this.wrapperRef.current.clientHeight),L()){const{viewer:e}=window.papayaContainers[0];window.papaya.Container.updateOrthogonalState(),e.resizeViewer([this.wrapperRef.current.clientWidth,this.wrapperRef.current.clientHeight])}});m(this,"onClick",e=>{const{showSeriesContextMenu:t}=this.props;if(e.which===3){const o=s=>{window.vDebug.log("ON CLICK BRO",s.type),s.type==="mouseup"&&t(e),this.wrapperRef.current.removeEventListener("mouseup",o),this.wrapperRef.current.removeEventListener("mousemove",o)};this.wrapperRef.current.addEventListener("mouseup",o),this.wrapperRef.current.addEventListener("mousemove",o)}});this.viewportRef=l.createRef(),this.wrapperRef=l.createRef()}componentDidMount(){this.setStateFromProps(),this.wrapperRef.current.addEventListener("mousedown",this.onClick,!0)}componentDidUpdate(e,t){const{stack:o,activeTool:s,viewportSpecificData:h,setViewportSpecificData:d}=this.props,{stack:S,activeTool:C,viewportSpecificData:f}=e,{finishedLoading:u,onMainImageChanged:r}=this.state,{finishedLoading:n}=t,{intensityActive:p,slabThickness:w,blendMode:y}=h,{intensityActive:c,slabThickness:I,blendMode:x}=f,{sliceThickness:k}=o;let P;L()&&(P=window.papayaContainers[0].viewer),n!==u&&u===!0&&d({slabThickness:k,sliceThickness:k,intensityActive:!1}),o.displaySetInstanceUID!==S.displaySetInstanceUID&&(L()&&window.papayaContainers[0].viewer.resetViewer(),this.loader.cancelCurrentPromisePool(),this.setState({progressLabel:this.props.translate("viewer.message.Downloading")}),this.setStateFromProps()),C!==s&&E(window.papayaContainers[0],s),p&&!c?(P.suspendSliceUpdate(),this.applyIntensity()):p&&r||w!==I&&typeof I!="undefined"||y!==x?(P.suspendSliceUpdate(),this.applyIntensity()):!p&&c&&P.drawViewer()}componentWillUnmount(){window.vDebug.log("papaya componentWillUnmount"),this.loader.cancelCurrentPromisePool(),this.dispose(),this.wrapperRef.current.removeEventListener("mousedown",this.onClick)}dispose(){L()&&(window.papayaContainers[0].viewer.resetViewer(),window.papayaContainers.length=0)}render(){const e=l.createElement("div",{className:"position-relative w-100 h-100",style:{zIndex:10}},l.createElement(T,{percentComplete:this.state.loadPercent,progressLabel:this.state.progressLabel}));return l.createElement(l.Fragment,null,!this.state.finishedLoading&&e,l.createElement("div",{className:"annotation",ref:this.wrapperRef},l.createElement(j,{handleWidth:!0,handleHeight:!0,skipOnMount:!0,refreshMode:"throttle",refreshRate:300,onResize:this.onWindowResize}),l.createElement("div",{ref:this.viewportRef,className:"papaya"})))}}m(A,"propTypes",{stack:g.exports.object,activeTool:g.exports.string,showSeriesContextMenu:g.exports.func,translate:g.exports.func,setViewportSpecificData:g.exports.func,viewportSpecificData:g.exports.object,showNotification:g.exports.func,displaySet:g.exports.object});const{setViewportSpecificData:te}=W.exports.redux.actions,ae=(i,a)=>{const{viewports:e}=i.viewer,{viewportIndex:t}=a;return{viewportSpecificData:e.viewportSpecificData[t]||{}}},se=(i,a)=>{const{viewportIndex:e}=a;return{showSeriesContextMenu:t=>{i(q(t))},showNotification:t=>{i(G(t))},setViewportSpecificData:t=>{i(te(e,t))}}},ne=z(H(ae,se),_);var oe=ne(A);const ie=i=>{const{viewportData:a={}}=i,{studies:e,displaySet:t}=a,[o,s]=D.exports.useState(null),[h,d]=D.exports.useState(null),[S]=D.exports.useState(null),[C,f]=D.exports.useState(!1),{stack:u={}}=o||{},{imageIds:r}=u,n=D.exports.useCallback(()=>{const{StudyInstanceUID:w,displaySetInstanceUID:y,sopClassUIDs:c,SOPInstanceUID:I,frameIndex:x,SeriesInstanceUID:k,plugin:P}=t;if(P!==K||!w||!y)return;c&&c.length>1&&window.vDebug.warn("More than one SOPClassUid in the same series is not yet supported.");const U=c[0];let v=M(e,w,y,U,I,x);v&&v.isDerived&&(v=M(e,w,v.originalDisplaySetInstanceUID,U,I,x));const R=Z(e,y);v.seriesInstanceUid=k,v.finishedLoading=!1,v.sliceThickness=R.calculatedSpacings.mostUnique,v.calculatedSpacings=R.calculatedSpacings,d(R),s({stack:v})},[t,e]);return D.exports.useEffect(()=>{if(n(),document.getElementById("mypapayascript")){f(!0);return}(function(){const y=X(),c=document.createElement("script");c.type="text/javascript",c.async=!0,c.src=`${y||""}/papaya.js`,c.id="mypapayascript";const I=document.getElementsByTagName("script")[0];I.parentNode.insertBefore(c,I),c.onload=()=>{f(!0)}})()},[n]),D.exports.useEffect(()=>{if(t){const{displaySetInstanceUID:w,SOPInstanceUID:y,frameIndex:c}=t;(w||y||!isNaN(c))&&n()}},[t,n]),C&&r?l.createElement(l.Fragment,null,l.createElement(oe,{stack:u,displaySet:h,...i})):l.createElement("div",{className:"position-relative w-100 h-100",style:{zIndex:10}},l.createElement(T,{error:S}))};ie.propTypes={viewportData:g.exports.object,translate:g.exports.func};export{ie as default};
